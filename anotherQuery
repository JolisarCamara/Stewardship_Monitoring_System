--  Create referenced table first
CREATE TABLE admins_role (
  placement_id SERIAL PRIMARY KEY,
  coordinator_placement VARCHAR(100) NOT NULL,
  description TEXT
);

--  Then scholar profiles
CREATE TABLE scholar_profiles (
  user_id INT PRIMARY KEY REFERENCES users(id) ON DELETE CASCADE,
  placement_id INT REFERENCES admins_role(placement_id),
  student_id VARCHAR(50) NOT NULL,
  course VARCHAR(100),
  year_level VARCHAR(20), 
  designation VARCHAR(100), 
  committed_day VARCHAR(50),
  committed_time VARCHAR(100), 
  required_stewardship_hours INT, 
  counterpart DECIMAL(10, 2), 
  coordinator VARCHAR(255)
);

-- Then admin profiles
CREATE TABLE admin_profiles (
  user_id INT PRIMARY KEY REFERENCES users(id) ON DELETE CASCADE,
  placement_id INT REFERENCES admins_role(placement_id)
);

--Insert placement
INSERT INTO admins_role (coordinator_placement, description) VALUES
('Student Affairs Office', 'Manages student organizations, discipline, and extracurricular services.'),
('Library', 'Manages academic resources, book collections, and student research assistance.'),
('Computer Laboratory', 'Maintains hardware, software, and network infrastructure; ensures the cleanliness of the lab.'),
('Registrar', 'Handles student enrollment, academic records, and transcript processing.'),
('Admin Office', 'Manages general school operations, faculty coordination, and executive tasks.'),
('Elementary/Highschool', 'Coordinates department-specific curriculum and basic education faculty.'),
('Clinic', 'Provides primary healthcare services and emergency medical assistance to students.'),
('Accounting Office', 'Manages payroll and the institution financial records.');

CREATE TABLE stewardship_logs (
  log_id SERIAL PRIMARY KEY,
  scholar_id INT NOT NULL REFERENCES scholar_profiles(user_id) ON DELETE CASCADE,
  log_date DATE NOT NULL DEFAULT CURRENT_DATE,
  time_in TIME NOT NULL,
  time_out TIME,
  total_hours DECIMAL(5, 2), 
  specific_accomplishment TEXT,
  -- Foreign key to admin_profiles, ensuring only admins can validate
  validated_by_admin_id INT REFERENCES admin_profiles(user_id),
  validation_status VARCHAR(20) DEFAULT 'Pending' -- 'Pending', 'Validated', 'Rejected'
);

--JOINS

--admin accounts with placement
SELECT 
        u.id, 
        u.name, 
        u.email, 
        r.name AS role_name,
        ar.coordinator_placement,
        ar.description AS placement_description,
        u.created_at
      FROM users u
      JOIN roles r ON u.role_id = r.id
      JOIN admin_profiles ap ON u.id = ap.user_id
      JOIN admins_role ar ON ap.placement_id = ar.placement_id
      WHERE r.name = 'admin' OR r.name = 'super-admin'
      ORDER BY u.created_at DESC

--stewardship logs
SELECT 
    u_scholar.name AS student_name,
    ar.coordinator_placement AS student_placement,
    sp.course AS program,
    sp.year_level,
    sl.log_date AS date,
    sl.time_in,
    sl.time_out,
    sl.total_hours,
    sl.specific_accomplishment,
    sl.validation_status,
    u_admin.name AS validator_name
FROM stewardship_logs sl
JOIN scholar_profiles sp ON sl.scholar_id = sp.user_id
JOIN users u_scholar ON sp.user_id = u_scholar.id
JOIN admins_role ar ON sp.placement_id = ar.placement_id
LEFT JOIN admin_profiles ap ON sl.validated_by_admin_id = ap.user_id
LEFT JOIN users u_admin ON ap.user_id = u_admin.id
ORDER BY sl.log_date DESC;